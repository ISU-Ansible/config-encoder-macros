{#
 # Jinja2 macro which converts Python data structure to TOML format
 #}

{%- macro toml_encode(
      item,
      convert_bools=false,
      convert_nums=false,
      first=[],
      indent="  ",
      level=0,
      prevkey="") %}

  {%- if item is mapping %}
    {#- The item is a dict #}

    {#- First process all strings, numbers and lists #}
    {%- for key, value in item.iteritems() | sort -%}
      {%- if value is string or
          value is number or
          (
            value is not mapping and
            value | length > 0 and
            value[0] is not mapping) %}

        {#- The value is a string, a number, or a list -#}
        {{ indent * level }}{{ key }}{{ " = " }}{{ toml_encode(
            value,
            convert_bools=convert_bools,
            convert_nums=convert_nums,
            first=first,
            indent=indent,
            level=level,
            prevkey=prevkey) }}
        {%- if first.append(1) %}{% endif %}
      {%- endif %}
    {%- endfor %}

    {#- Then process all data structures #}
    {%- for key, value in item.iteritems() | sort %}
      {%- if value is not string and
          value is not number and
          (
            value is mapping or
            value[0] is mapping) %}

        {%- set old_prevkey = prevkey %}
        {%- set old_level = level %}

        {%- if value is mapping %}
          {#- The value is a dict #}
          {%- if prevkey != "" and prevkey != key %}
            {%- set level = level + 1 %}
          {%- endif %}

          {%- set prevkey = (key if prevkey == "" else prevkey + "." + key) %}

          {%- if first | length > 0 -%}
            {{ "\n" }}
          {%- endif -%}

          {{ indent * level }}[{{ prevkey }}]{{ "\n" }}
        {%- elif value[0] is mapping %}
          {#- The value is a table #}
          {%- set prevkey = (key if prevkey == "" else prevkey + "." + key) %}
          {%- set level = level +1 %}
        {%- endif -%}

        {{ toml_encode(
            value,
            convert_bools=convert_bools,
            convert_nums=convert_nums,
            first=first,
            indent=indent,
            level=level,
            prevkey=prevkey) }}

        {%- set prevkey = old_prevkey %}
        {%- set level = old_level %}
        {%- if first.append(1) %}{% endif %}
      {%- endif %}
    {%- endfor %}

  {%- elif item is number or
      (convert_nums and (
        item | int | string == item or
        item | float | string == item)) or
      item in ["true", "True", "false", "False"] %}

    {#- The item is a number or boolean -#}
    {{ item | lower }}{{ "\n" }}

  {%- elif item is string %}
    {#- The item is a string -#}
    "{{ item | replace("\n", "\\n") | replace("\t", "\\t") }}"{{ "\n" }}

  {%- else %}
    {#- The item is a list #}
    {%- if item[0] is mapping %}
      {%- for d in item -%}
        {{ "\n" }}{{ indent * level }}[[{{ prevkey }}]]{{ "\n" }}{{ toml_encode(
            d,
            convert_bools=convert_bools,
            convert_nums=convert_nums,
            first=first,
            indent=indent,
            level=level) }}
      {%- endfor %}
    {%- else -%}
      {{ item }}{{ "\n" }}
    {%- endif %}
  {%- endif %}
{%- endmacro %}
